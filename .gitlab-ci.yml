variables:
  COV_THRESHOLD: '90'

include:
  - project: ccx/ccx-gitlab-includes
    ref: master
    file: /ccx-lib.yml


stages:
  - lint
  - test
  - covcheck


linting:
  extends: .pre-commit:lint
  stage: lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'


pre-commit-autoupdate-check:
  extends: .pre-commit:autoupdate-check
  stage: lint
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

test-py311:
  extends: .python:test
  variables:
    PYTHON_VENV_FROM: python3.11
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'


coverage-checking:
  extends: .coverage-check
  stage: covcheck
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  allow_failure: true

bdd-tests:
  stage: test
  image: quay.io/redhat-services-prod/obsint-processing-tenant/insights-behavioral-spec/insights-behavioral-spec:latest
  variables:
    PATH_TO_LOCAL_DATA_ENG_SERVICE: "$CI_PROJECT_DIR"
    BDD_PATH: /insights-behavioral-spec
    VIRTUAL_ENV: /insights-behavioral-spec-venv/
    WITHMOCK: "1"
    http_proxy: ""
    HTTP_PROXY: ""
    https_proxy: ""
    HTTPS_PROXY: ""
    # variables for the runner
    KUBERNETES_CPU_REQUEST: "500m"
    KUBERNETES_CPU_LIMIT: "1"
    KUBERNETES_MEMORY_REQUEST: "2Gi"
    KUBERNETES_MEMORY_LIMIT: "4Gi"
    KUBERNETES_SERVICE_CPU_LIMIT: "500m"
    KUBERNETES_SERVICE_MEMORY_LIMIT: "2Gi"


  script:
    - cd $BDD_PATH
    - make data-engineering-service-tests
  after_script:
    - cp -r "$BDD_PATH/logs/ccx-upgrades-data-eng" "$CI_PROJECT_DIR/logs"
  artifacts:
    untracked: true
    when: on_failure
    paths:
      - ./logs
    expire_in: 1 week
  services:
    - name: ghcr.io/navikt/mock-oauth2-server:2.2.1
      alias: mock-oauth2-server
      variables:
        PORT: 8081
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'


pre-commit-autoupdate:
  extends: .pre-commit:autoupdate
  stage: lint
  rules:
  - if: $CI_PIPELINE_SOURCE == "schedule"
  variables:
    MAINTAINERS: "@jdiazsua @ireyes"
